<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HERMECO | Portafolio de Proyectos Estrategicos</title>
  <meta property="og:title" content="Portafolio Estrat√©gico HERMECO">
<meta property="og:description" content="Visualiza el estado de los proyectos estrat√©gicos de HERMECO en tiempo real.">
<meta property="og:image" content="favicon.png">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS -->
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCeIhrajV6Fppw9wU7VFCSLFk4XB0Upcws",
      authDomain: "protafolio-proyectos-hermeco.firebaseapp.com",
      projectId: "protafolio-proyectos-hermeco",
      storageBucket: "protafolio-proyectos-hermeco.appspot.com",
      messagingSenderId: "729741794649",
      appId: "1:729741794649:web:05e32082b2c457f6c78048",
      measurementId: "G-3kBCB0X2K2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'herm-yellow': '#FFF200',
            'herm-dark-blue': '#005B7F',
            'herm-success-green': '#8DC63F',
            'herm-alert-red': '#ED1C24',
            'herm-light-gray': '#EDEDED',
            'herm-alert-yellow': '#FFD200',
          },
          fontFamily: {
            sans: ['Century Gothic', 'Segoe UI', 'Inter', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <link rel="icon" type="image/png" href="favicon.png">
</head>

<body class="bg-gray-100 min-h-screen font-sans">
  <div class="max-w-7xl mx-auto p-4 md:p-8">

    <!-- ENCABEZADO -->
    <header class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row justify-between items-start md:items-center">
      <div class="flex items-center space-x-4">
        <img src="https://i.imgur.com/B3WsOI7.png" alt="Logo HERMECO OFFCORSS" class="h-14 w-auto">
        <div>
          <h1 class="text-3xl font-extrabold text-herm-dark-blue">
            Portafolio de Proyectos Estrat√©gicos HERMECO
          </h1>
          <p class="text-gray-500 mt-1">Alineaci√≥n con la estrategia corporativa</p>
          <p id="update-date" class="text-xs text-gray-400 mt-1"></p>
        </div>
      </div>

      <div class="flex flex-col md:flex-row gap-2 mt-4 md:mt-0 items-center">
        <button id="admin-tab"
          class="px-4 py-2 rounded-full bg-herm-dark-blue text-white font-semibold shadow-md hover:bg-herm-dark-blue/90 transition">
          Panel de Administraci√≥n
        </button>
        <button id="committee-tab"
          class="px-4 py-2 rounded-full bg-herm-yellow text-herm-dark-blue font-semibold shadow-md hover:bg-herm-yellow/80 transition">
          Vista del Comit√©
        </button>
      </div>
    </header>

    <!-- PANEL DE ADMINISTRACI√ìN -->
    <div id="admin-view" class="hidden">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-herm-dark-blue mb-4">Panel de Administraci√≥n</h2>
        <p class="text-gray-600 mb-4">Carga aqu√≠ el archivo actualizado del portafolio. Los datos se guardar√°n autom√°ticamente para todos los miembros del comit√©.</p>

        <label for="admin-file-upload"
          class="cursor-pointer inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-herm-success-green hover:bg-herm-success-green/90 transition duration-150 ease-in-out">
          <i data-lucide="upload" class="w-5 h-5 mr-2"></i>Cargar archivo (CSV/XLSX)
        </label>
        <input id="admin-file-upload" type="file" accept=".csv, .xlsx" class="hidden">
        <div id="admin-message" class="mt-6 text-herm-success-green hidden font-semibold">‚úÖ Datos actualizados correctamente</div>
      </div>
    </div>

    <!-- VISTA DEL COMIT√â -->
    <div id="committee-view" class="block">
      <div id="dashboard-view" class="grid grid-cols-12 gap-8">
        <div class="col-span-12 lg:col-span-4 flex flex-col gap-6">
         <div class="bg-herm-yellow p-6 rounded-xl shadow-xl">
  <div class="flex flex-wrap justify-center gap-6">
    <div class="flex flex-col items-center justify-center bg-white p-5 min-w-[130px] w-[160px] rounded-xl shadow hover:scale-105 transition-transform">
      <h3 class="text-xs sm:text-sm text-gray-500 font-semibold uppercase text-center leading-tight">Total</h3>
      <p id="total-count" class="text-4xl font-bold text-herm-dark-blue">0</p>
    </div>
    
    <div class="flex flex-col items-center justify-center bg-white p-5 min-w-[130px] w-[160px] rounded-xl shadow hover:scale-105 transition-transform cursor-pointer">
      <h3 class="text-xs sm:text-sm text-gray-500 font-semibold uppercase text-center leading-tight">Ejecuci√≥n</h3>
      <p id="execution-count" class="text-4xl font-bold text-herm-dark-blue">0</p>
    </div>
    
    <div class="flex flex-col items-center justify-center bg-white p-5 min-w-[130px] w-[160px] rounded-xl shadow hover:scale-105 transition-transform cursor-pointer">
      <h3 class="text-xs sm:text-sm text-gray-500 font-semibold uppercase text-center leading-tight break-words">Estructuraci√≥n</h3>
      <p id="structuring-count" class="text-4xl font-bold text-herm-dark-blue">0</p>
    </div>
  </div>
</div>


          <div class="bg-white p-6 rounded-xl shadow-xl flex-grow">
            <h2 class="text-xl font-bold mb-4 text-herm-dark-blue">Estado General del Portafolio</h2>
            <div class="flex flex-col items-center">
              <canvas id="donut-chart" class="w-full h-64"></canvas>
              <div id="chart-legend" class="mt-4 space-y-1 text-sm w-full"></div>
            </div>
          </div>
        </div>

        <div class="col-span-12 lg:col-span-8 bg-herm-light-gray p-6 rounded-xl shadow-xl">
          <h2 class="text-2xl font-bold mb-6 text-herm-dark-blue">Alineaci√≥n con la estrategia</h2>
          <div id="okr-cards-container" class="grid grid-cols-1 gap-6"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS PRINCIPAL -->
  <script type="module">
    import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const COLORS = {
      'A Tiempo': { hex: '#8DC63F', tailwind: 'bg-herm-success-green' },
      'Con Alerta': { hex: '#FFD200', tailwind: 'bg-herm-alert-yellow' },
      'En Riesgo': { hex: '#ED1C24', tailwind: 'bg-herm-alert-red' },
    };

    let projectData = [];
    const db = window.db;

    function parsePercentage(v) {
      if (v === null || v === undefined) return 0;
      if (typeof v === 'number') return v > 1 ? v / 100 : v;
      const cleaned = String(v).replace('%', '').replace(',', '.').trim();
      const n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n > 1 ? n / 100 : n;
    }

    function classifyProject(a) {
      if (a < 0.61) return COLORS['En Riesgo'];
      if (a <= 0.81) return COLORS['Con Alerta'];
      return COLORS['A Tiempo'];
    }

    async function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (ev) => {
        const wb = XLSX.read(ev.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws);
        await saveToFirestore(json);
      };
      reader.readAsBinaryString(file);
    }

  async function saveToFirestore(rows) {
  const now = new Date().toLocaleString('es-CO');

  // üß† Funci√≥n auxiliar para convertir fechas de Excel a formato dd/mm/aaaa
  const excelDateToJS = (excelDate) => {
    if (!excelDate) return '';
    // Si ya viene como texto, devolverlo igual
    if (typeof excelDate === 'string') return excelDate;
    // Si viene como n√∫mero (caso t√≠pico de Excel)
    const date = new Date((excelDate - 25569) * 86400 * 1000); // Excel epoch ‚Üí JS date
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  };

  const processed = rows.map(r => {
    const p = {};
    for (let k in r) p[k.trim().toLowerCase()] = r[k];
    
    const av = parsePercentage(p['% avance'] ?? p['avance']);
    const id = parsePercentage(p['% ideal'] ?? p['ideal']);
    const cu = parsePercentage(p['% cumplimiento'] ?? p['cumplimiento']);
    const st = classifyProject(av);

    return {
      okr: p['okr'] || 'Sin OKR',
      nombre: p['nombre del proyecto'] || '',
      etapa: p['etapa'] || '',
      objetivo: p['objetivo'] || '',
      indicadores: p['indicadores'] || '',
      entregables: p['entregables'] || '',
      comite: p['comite patrocinador'] || '',
      lider: p['lider'] || '',
      equipo: p['equipo'] || '',

      // üóìÔ∏è Fechas convertidas de Excel a formato dd/mm/aaaa
      fecha_inicio: excelDateToJS(p['fecha inicio']),
      fecha_fin: excelDateToJS(p['fecha fin']),
      fecha_fin_me: excelDateToJS(p['fecha fin me']),

      avance: av,
      ideal: id,
      cumplimiento: cu,
      estado: Object.keys(COLORS).find(k => COLORS[k].hex === st.hex),
      color: st.hex,
      tailwind: st.tailwind
    };
  });

  await setDoc(doc(db, "portafolio", "data"), {
    proyectos: processed,
    fecha: now
  });

  document.getElementById('admin-message').classList.remove('hidden');
  setTimeout(() => document.getElementById('admin-message').classList.add('hidden'), 3000);
}



    async function showCommitteeView() {
      document.getElementById("admin-view").classList.add("hidden");
      document.getElementById("committee-view").classList.remove("hidden");

      const snap = await getDoc(doc(db, "portafolio", "data"));
      if (snap.exists()) {
        const data = snap.data();
        projectData = data.proyectos;
        document.getElementById("update-date").textContent = `Fecha de actualizaci√≥n: ${data.fecha}`;
        renderDashboard();
      } else {
        alert("No hay datos cargados en Firestore");
      }
    }

    function showAdminView() {
      document.getElementById("admin-view").classList.remove("hidden");
      document.getElementById("committee-view").classList.add("hidden");
    }

   function renderProjects() {
  const container = document.getElementById("okr-cards-container");
  container.innerHTML = "";

  const okrGroups = {};
  projectData.forEach(p => {
    if (!okrGroups[p.okr]) okrGroups[p.okr] = [];
    okrGroups[p.okr].push(p);
  });

  Object.keys(okrGroups).forEach(okr => {
    const group = okrGroups[okr];
    const safeId = okr.replace(/[^a-zA-Z0-9]/g, "_");

    const okrCard = document.createElement("div");
    okrCard.className = "bg-white p-5 rounded-xl shadow-lg border-l-8 border-herm-dark-blue mb-6";

    okrCard.innerHTML = `
      <h3 class="text-xl font-bold text-herm-dark-blue mb-3">${okr}</h3>
      <p class="text-sm text-gray-500 mb-4">${group.length} proyecto(s)</p>
      <div class="space-y-3" id="projects-${safeId}"></div>
    `;

    const groupContainer = okrCard.querySelector(`#projects-${safeId}`);

    group.forEach((p, i) => {
      const projectId = `${safeId}-${i}`;
      const avance = (p.avance * 100).toFixed(1);
      const ideal = (p.ideal * 100).toFixed(1);
      const cumplimiento = (p.cumplimiento * 100).toFixed(1);

      const card = document.createElement("div");
      card.className =
        "bg-gray-50 rounded-lg border-t-4 shadow-md overflow-hidden transition-all duration-300";
      card.style.borderColor = p.color;

      card.innerHTML = `
        <!-- CABECERA -->
        <button id="header-${projectId}"
          class="w-full flex justify-between items-center p-4 text-left hover:bg-gray-100 transition">
          <div>
            <h4 class="font-semibold text-herm-dark-blue">${p.nombre}</h4>
            <p class="text-xs text-gray-600"><strong>L√≠der:</strong> ${p.lider}</p>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-xs px-3 py-1 rounded-full text-white ${p.tailwind}">${p.estado}</span>
            <i data-lucide="chevron-down" class="w-5 h-5 text-gray-500 transition-transform"></i>
          </div>
        </button>

        <!-- DETALLE (oculto por defecto) -->
        <div id="body-${projectId}" class="hidden p-4 border-t bg-white">
          <p class="text-sm text-gray-700 mb-2"><strong>Comit√© patrocinador:</strong> ${p.comite}</p>
          <p class="text-sm text-gray-700 mb-3"><strong>Objetivo:</strong> ${p.objetivo}</p>
  <!-- üóìÔ∏è Fechas clave del proyecto -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
    <p class="text-xs text-gray-700"><strong>Inicio:</strong> ${p.fecha_inicio || "‚Äî"}</p>
    <p class="text-xs text-gray-700"><strong>Fin:</strong> ${p.fecha_fin || "‚Äî"}</p>
    <p class="text-xs text-gray-700"><strong>Fin ME:</strong> ${p.fecha_fin_me || "‚Äî"}</p>
  </div>


          <div class="grid grid-cols-3 text-center mb-4">
            <div>
              <p class="text-xs text-gray-500">% Avance</p>
              <p class="text-lg font-bold text-herm-dark-blue">${avance}%</p>
            </div>
            <div>
              <p class="text-xs text-gray-500">% Ideal</p>
              <p class="text-lg font-bold text-herm-dark-blue">${ideal}%</p>
            </div>
            <div>
              <p class="text-xs text-gray-500">% Cumplimiento</p>
              <p class="text-lg font-bold text-herm-dark-blue">${cumplimiento}%</p>
            </div>
          </div>

          <div class="mb-3">
            <p class="text-sm font-semibold text-herm-dark-blue">Entregables:</p>
            <p class="text-sm text-gray-600 whitespace-pre-line">${p.entregables || "‚Äî"}</p>
          </div>

          <div>
            <p class="text-sm font-semibold text-herm-dark-blue">Indicadores:</p>
            <p class="text-sm text-gray-600 whitespace-pre-line">${p.indicadores || "‚Äî"}</p>
          </div>
        </div>
      `;

      groupContainer.appendChild(card);

      // Evento para abrir/cerrar detalle
      const header = card.querySelector(`#header-${projectId}`);
      const body = card.querySelector(`#body-${projectId}`);
      const icon = header.querySelector("i");

      header.addEventListener("click", () => {
        const isOpen = !body.classList.contains("hidden");
        document.querySelectorAll(`#projects-${safeId} [id^="body-"]`).forEach(el => el.classList.add("hidden"));
        document.querySelectorAll(`#projects-${safeId} i[data-lucide="chevron-down"]`).forEach(el => el.style.transform = "rotate(0deg)");
        if (!isOpen) {
          body.classList.remove("hidden");
          icon.style.transform = "rotate(180deg)";
        }
      });
    });

    container.appendChild(okrCard);
  });

  lucide.createIcons();
}


function renderChart() {
  const canvas = document.getElementById("donut-chart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  const counts = { 'A Tiempo': 0, 'Con Alerta': 0, 'En Riesgo': 0 };
  projectData.forEach(p => { counts[p.estado]++; });

  const labels = Object.keys(counts);
  const data = Object.values(counts);
  const colors = labels.map(l => COLORS[l].hex);

  // limpiar gr√°fico anterior
  if (window.donutChart) window.donutChart.destroy();

  // crear contenedor de detalle din√°mico
  const legend = document.getElementById("chart-legend");
  legend.innerHTML = `
    <div id="chart-projects-list" class="mt-3 text-sm text-gray-700"></div>
  `;

  const projectListContainer = document.getElementById("chart-projects-list");

  // Crear gr√°fico
    window.donutChart = new Chart(ctx, {
    type: "doughnut",
    data: { 
      labels, 
      datasets: [{ 
        data, 
        backgroundColor: colors 
      }] 
    },
    options: {
      cutout: "70%",
      plugins: {
        legend: { 
          display: true, 
          labels: { color: '#005B7F', font: { size: 12, family: 'Century Gothic' } } 
        },
        tooltip: { enabled: false },
        datalabels: {
          color: '#005B7F',          // üü° Color del texto
          font: {
            weight: 'bold',
            size: 30,                // üü¢ Tama√±o del n√∫mero (aj√∫stalo como quieras)
            family: 'Century Gothic'
          },
          formatter: (value, context) => {
            const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
            const percent = ((value / total) * 100).toFixed(0);
            return `${value}`;   // muestra n√∫mero
          },
          anchor: 'center',
          align: 'center',
        }
      },
      onClick: (event, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const status = labels[index];
          showProjectsByStatus(status);
        }
      }
    },
    plugins: [ChartDataLabels]  // ‚úÖ el plugin activado correctamente
  });

  // Mostrar lista de proyectos seg√∫n estado
  function showProjectsByStatus(status) {
    const projects = projectData.filter(p => p.estado === status);
    if (projects.length === 0) {
      projectListContainer.innerHTML = `<p class="text-gray-500 italic">No hay proyectos en este estado.</p>`;
      return;
    }

    projectListContainer.innerHTML = `
      <p class="font-semibold text-herm-dark-blue mb-1">${status}</p>
      <ul class="list-disc ml-5 space-y-1 text-gray-700">
        ${projects.map(p => `<li>${p.nombre}</li>`).join("")}
      </ul>
    `;
  }
}

function renderDashboard() {
  if (projectData.length === 0) return;
  document.getElementById('total-count').textContent = projectData.length;
  document.getElementById('execution-count').textContent = projectData.filter(p => p.etapa.toLowerCase().includes('ejec')).length;
  document.getElementById('structuring-count').textContent = projectData.filter(p => p.etapa.toLowerCase().includes('estruc')).length;

  // üéØ Click sobre las tarjetas superiores
  document.getElementById('execution-count').parentElement.onclick = () => showProjectsByStage('Ejecuci√≥n');
  document.getElementById('structuring-count').parentElement.onclick = () => showProjectsByStage('Estructuraci√≥n');

  renderProjects();
  renderChart();
}

// üü¶ Mostrar proyectos seg√∫n etapa (sin detalle)
function showProjectsByStage(stageName) {
  const filtered = projectData.filter(p => p.etapa.toLowerCase().includes(stageName.toLowerCase()));
  const list = filtered.map(p => `<li>${p.nombre}</li>`).join("");

  Swal.fire({
    title: `Proyectos en ${stageName}`,
    html: `<ul class="text-left list-disc ml-6 text-gray-700">${list || "<li>No hay proyectos en esta etapa.</li>"}</ul>`,
    icon: "info",
    confirmButtonText: "Cerrar",
    confirmButtonColor: "#005B7F"
  });
}

window.onload = () => {
  showCommitteeView();
  document.getElementById("admin-tab").addEventListener("click", showAdminView);
  document.getElementById("committee-tab").addEventListener("click", showCommitteeView);
  document.getElementById("admin-file-upload").addEventListener("change", handleFileUpload);
};

  </script>
</body>

</html>

