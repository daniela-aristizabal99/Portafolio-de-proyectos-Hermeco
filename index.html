<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HERMECO | Portafolio de Proyectos Estrategicos v2</title>
  <meta property="og:title" content="Portafolio Estratégico HERMECO">
<meta property="og:description" content="Visualiza el estado de los proyectos estratégicos de HERMECO en tiempo real.">
<meta property="og:image" content="favicon.png">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS -->
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCeIhrajV6Fppw9wU7VFCSLFk4XB0Upcws",
      authDomain: "protafolio-proyectos-hermeco.firebaseapp.com",
      projectId: "protafolio-proyectos-hermeco",
      storageBucket: "protafolio-proyectos-hermeco.appspot.com",
      messagingSenderId: "729741794649",
      appId: "1:729741794649:web:05e32082b2c457f6c78048",
      measurementId: "G-3kBCB0X2K2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.firebase = { doc, onSnapshot, setDoc };
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'herm-yellow': '#FFF200',
            'herm-dark-blue': '#005B7F',
            'herm-success-green': '#8DC63F',
            'herm-alert-red': '#ED1C24',
            'herm-light-gray': '#EDEDED',
            'herm-alert-yellow': '#FFD200',
          },
          fontFamily: {
            sans: ['Century Gothic', 'Segoe UI', 'Inter', 'sans-serif'],
          },
        },
      },
    };
  </script>
  <link rel="icon" type="image/png" href="favicon.png">
</head>

<body class="bg-gray-100 min-h-screen font-sans">
  <div class="max-w-7xl mx-auto p-4 md:p-8">

    <!-- ENCABEZADO -->
    <header class="bg-white rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row justify-between items-start md:items-center">
      <div class="flex items-center space-x-4">
        <img src="https://i.imgur.com/B3WsOI7.png" alt="Logo HERMECO OFFCORSS" class="h-14 w-auto">
        <div>
          <h1 class="text-3xl font-extrabold text-herm-dark-blue">
            Portafolio de Proyectos Estratégicos HERMECO
          </h1>
          <p class="text-gray-500 mt-1">Alineación con la estrategia corporativa</p>
          <p id="update-date" class="text-xs text-gray-400 mt-1"></p>
        </div>
      </div>

      <div class="flex flex-col md:flex-row gap-2 mt-4 md:mt-0 items-center">
        <button id="admin-tab"
          class="px-4 py-2 rounded-full bg-herm-dark-blue text-white font-semibold shadow-md hover:bg-herm-dark-blue/90 transition">
          Panel de Administración
        </button>
        <button id="committee-tab"
          class="px-4 py-2 rounded-full bg-herm-yellow text-herm-dark-blue font-semibold shadow-md hover:bg-herm-yellow/80 transition">
          Vista del Comité
        </button>
      </div>
    </header>

    <!-- PANEL DE ADMINISTRACIÓN -->
    <div id="admin-view" class="hidden">
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-herm-dark-blue mb-4">Panel de Administración</h2>
        <p class="text-gray-600 mb-4">Carga aquí el archivo actualizado del portafolio. Los datos se guardarán automáticamente para todos los miembros del comité.</p>

        <label id="upload-label" for="admin-file-upload"
          class="cursor-pointer inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-herm-success-green hover:bg-herm-success-green/90 transition duration-150 ease-in-out">
          <i data-lucide="upload" class="w-5 h-5 mr-2"></i>Cargar archivo (CSV/XLSX)
        </label>
        <input id="admin-file-upload" type="file" accept=".csv, .xlsx" class="hidden">
      </div>
    </div>

    <!-- VISTA DEL COMITÉ -->
    <div id="committee-view" class="block">
      <div id="dashboard-view" class="grid grid-cols-12 gap-8">
        <div class="col-span-12 lg:col-span-4 flex flex-col gap-6">
         <div class="bg-herm-yellow p-6 rounded-xl shadow-xl">
  <div class="flex flex-wrap justify-center gap-6">
    <div class="flex flex-col items-center justify-center bg-white p-5 min-w-[130px] w-[160px] rounded-xl shadow hover:scale-105 transition-transform">
      <h3 class="text-xs sm:text-sm text-gray-500 font-semibold uppercase text-center leading-tight">Total</h3>
      <p id="total-count" class="text-4xl font-bold text-herm-dark-blue">0</p>
    </div>
    
    <div class="flex flex-col items-center justify-center bg-white p-5 min-w-[130px] w-[160px] rounded-xl shadow hover:scale-105 transition-transform cursor-pointer">
      <h3 class="text-xs sm:text-sm text-gray-500 font-semibold uppercase text-center leading-tight">Ejecución</h3>
      <p id="execution-count" class="text-4xl font-bold text-herm-dark-blue">0</p>
    </div>
    
    <div class="flex flex-col items-center justify-center bg-white p-5 min-w-[130px] w-[160px] rounded-xl shadow hover:scale-105 transition-transform cursor-pointer">
      <h3 class="text-xs sm:text-sm text-gray-500 font-semibold uppercase text-center leading-tight break-words">Estructuración</h3>
      <p id="structuring-count" class="text-4xl font-bold text-herm-dark-blue">0</p>
    </div>

    <div class="flex flex-col items-center justify-center bg-white p-5 min-w-[130px] w-[160px] rounded-xl shadow hover:scale-105 transition-transform cursor-pointer">
      <h3 class="text-xs sm:text-sm text-gray-500 font-semibold uppercase text-center leading-tight">Cierre</h3>
      <p id="closure-count" class="text-4xl font-bold text-herm-dark-blue">0</p>
    </div>
  </div>
</div>


          <div class="bg-white p-6 rounded-xl shadow-xl flex-grow">
            <h2 class="text-xl font-bold mb-4 text-herm-dark-blue">Estado General del Portafolio</h2>
            <div class="flex flex-col items-center">
              <canvas id="donut-chart" class="w-full h-64"></canvas>
              <div id="chart-legend" class="mt-4 space-y-1 text-sm w-full"></div>
            </div>
          </div>
        </div>

        <div class="col-span-12 lg:col-span-8 bg-herm-light-gray p-6 rounded-xl shadow-xl">
          <h2 class="text-2xl font-bold mb-6 text-herm-dark-blue">Alineación con la estrategia</h2>
          <div id="okr-cards-container" class="grid grid-cols-1 gap-6"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS PRINCIPAL -->
  <script type="module">
    const { doc, onSnapshot, setDoc } = window.firebase;
    const db = window.db;

    const COLORS = {
      'A Tiempo': { hex: '#8DC63F', tailwind: 'bg-herm-success-green' },
      'Con Alerta': { hex: '#FFD200', tailwind: 'bg-herm-alert-yellow' },
      'En Riesgo': { hex: '#ED1C24', tailwind: 'bg-herm-alert-red' },
      'Sin datos': { hex: '#D6D6D6', tailwind: 'bg-gray-300' },
    };

    let projectData = [];

function parsePercentage(v) {
  if (v === null || v === undefined) return 0;
  let n = 0;
  if (typeof v === "number") {
    n = v;
  } else {
    const cleaned = String(v).replace("%", "").replace(",", ".").trim();
    n = parseFloat(cleaned);
  }
  if (isNaN(n)) return 0;
  if (n <= 1) return n * 100;
  if (n > 1 && n < 5) return n * 100;
  if (n >= 5 && n <= 300) return n;
  if (n > 300 && n <= 9999) return n / 100;
  return n / 1000;
}

function classifyProject(avance, ideal, cumplimiento) {
  if (!avance || !ideal || isNaN(avance) || isNaN(ideal) || avance === 0 || ideal === 0) {
    return { ...COLORS["Sin datos"], estado: "Sin datos", vencido: false };
  }
  const a = Math.round(avance * 10) / 10;
  const i = Math.round(ideal * 10) / 10;
  const c = Math.round(cumplimiento * 10) / 10;
  let vencido = false;
  if (i >= 100 && c < 100) vencido = true;
  if (vencido) {
    return { ...COLORS["En Riesgo"], estado: "En Riesgo", vencido: true };
  }
  if (c <= 60) return { ...COLORS["En Riesgo"], estado: "En Riesgo", vencido };
  if (c > 60 && c <= 80) return { ...COLORS["Con Alerta"], estado: "Con Alerta", vencido };
  if (c > 80) return { ...COLORS["A Tiempo"], estado: "A Tiempo", vencido };
  return { ...COLORS["Sin datos"], estado: "Sin datos", vencido: false };
}

    async function handleFileUpload(e) {
      const file = e.target.files[0];
      const uploadLabel = document.getElementById('upload-label');
      if (!file) return;

      uploadLabel.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-2"></i>Procesando...';
      uploadLabel.classList.add('opacity-50', 'cursor-not-allowed');
      lucide.createIcons();
      
      const reader = new FileReader();
      reader.onload = async (ev) => {
        try {
            const wb = XLSX.read(ev.target.result, { type: 'binary' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws);
            await saveToFirestore(json);
            Swal.fire({
                icon: 'success',
                title: '¡Datos actualizados!',
                text: 'El portafolio de proyectos se ha actualizado correctamente.',
                timer: 2000,
                showConfirmButton: false
            });
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error al procesar el archivo',
                text: error.message
            });
        } finally {
            uploadLabel.innerHTML = '<i data-lucide="upload" class="w-5 h-5 mr-2"></i>Cargar archivo (CSV/XLSX)';
            uploadLabel.classList.remove('opacity-50', 'cursor-not-allowed');
            lucide.createIcons();
            e.target.value = '';
        }
      };
      reader.onerror = () => {
          Swal.fire({
              icon: 'error',
              title: 'Error de Lectura',
              text: 'No se pudo leer el archivo seleccionado.'
          });
          uploadLabel.innerHTML = '<i data-lucide="upload" class="w-5 h-5 mr-2"></i>Cargar archivo (CSV/XLSX)';
          uploadLabel.classList.remove('opacity-50', 'cursor-not-allowed');
          lucide.createIcons();
      };
      reader.readAsBinaryString(file);
    }

  async function saveToFirestore(rows) {
      const now = new Date().toLocaleString('es-CO');
      const excelDateToJS = (excelDate) => {
        if (!excelDate) return '';
        if (typeof excelDate === 'string') return excelDate;
        const date = new Date((excelDate - 25569) * 86400 * 1000);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      };

     const processed = rows.map(r => {
      const p = {};
      for (let k in r) p[k.trim().toLowerCase()] = r[k];
      const av = parsePercentage(p['% avance'] ?? p['avance']);
      const id = parsePercentage(p['% ideal'] ?? p['ideal']);
      let cu = (id > 0 && av > 0) ? (av / id) * 100 : 0;
      const st = classifyProject(av, id, cu);

        return {
          okr: p['okr'] || 'Sin OKR',
          nombre: p['nombre del proyecto'] || '',
          etapa: p['etapa'] || '',
          objetivo: p['objetivo'] || '',
          indicadores: p['indicadores'] || '',
          entregables: p['entregables'] || '',
          comite: p['comite patrocinador'] || '',
          lider: p['lider'] || '',
          equipo: p['equipo'] || '',
          fecha_inicio: excelDateToJS(p['fecha inicio']),
          fecha_fin: excelDateToJS(p['fecha fin']),
          fecha_fin_me: excelDateToJS(p['fecha fin me']),
          avance: av,
          ideal: id,
          cumplimiento: parseFloat(cu.toFixed(2)),
          estado: st.estado || Object.keys(COLORS).find(k => COLORS[k].hex === st.hex) || "Sin datos",
          color: st.hex,
          tailwind: st.tailwind
        };
      });

      await setDoc(doc(db, "portafolio", "data"), {
        proyectos: processed,
        fecha: now
      });
}

function renderEmptyState() {
    const container = document.getElementById("okr-cards-container");
    container.innerHTML = `
        <div class="text-center py-12">
            <p class="text-lg font-semibold text-gray-500">No hay proyectos cargados</p>
            <p class="text-gray-400 mt-2">Sube un archivo en el panel de administración para empezar.</p>
        </div>
    `;
    document.getElementById('total-count').textContent = '0';
    document.getElementById('execution-count').textContent = '0';
    document.getElementById('structuring-count').textContent = '0';
    document.getElementById('closure-count').textContent = '0';
    if(window.donutChart) window.donutChart.destroy();
}


function showCommitteeView() {
  document.getElementById("admin-view").classList.add("hidden");
  document.getElementById("committee-view").classList.remove("hidden");
  
  onSnapshot(doc(db, "portafolio", "data"), (snap) => {
    if (!snap.exists() || !snap.data().proyectos || snap.data().proyectos.length === 0) {
      renderEmptyState();
      return;
    }

    const data = snap.data();
    projectData = (data.proyectos || []).map(p => {
        const st = classifyProject(p.avance, p.ideal, p.cumplimiento);
        const estadoKey = st.estado || Object.keys(COLORS).find(k => COLORS[k].hex === st.hex) || 'Sin datos';
        return { ...p, estado: estadoKey, color: st.hex, tailwind: st.tailwind };
    });

    document.getElementById("update-date").textContent = `Fecha de actualización: ${data.fecha}`;
    renderDashboard();
  });
}

    function showAdminView() {
      document.getElementById("admin-view").classList.remove("hidden");
      document.getElementById("committee-view").classList.add("hidden");
    }

   function renderProjects() {
      const container = document.getElementById("okr-cards-container");
      container.innerHTML = "";

      const okrGroups = {};
      projectData.forEach(p => {
        if (!okrGroups[p.okr]) okrGroups[p.okr] = [];
        okrGroups[p.okr].push(p);
      });

      Object.keys(okrGroups).sort().forEach(okr => {
        const group = okrGroups[okr];
        const safeId = okr.replace(/[^a-zA-Z0-9]/g, "_");

        const okrCard = document.createElement("div");
        okrCard.className = "bg-white p-5 rounded-xl shadow-lg border-l-8 border-herm-dark-blue mb-6";

        okrCard.innerHTML = `
          <h3 class="text-xl font-bold text-herm-dark-blue mb-3">${okr}</h3>
          <p class="text-sm text-gray-500 mb-4">${group.length} proyecto(s)</p>
          <div class="space-y-3" id="projects-${safeId}"></div>
        `;

        const groupContainer = okrCard.querySelector(`#projects-${safeId}`);

        group.forEach((p, i) => {
          const projectId = `${safeId}-${i}`;
          const avance = isNaN(p.avance) || p.avance === 0 ? "N/A" : p.avance.toFixed(1);
          const ideal = isNaN(p.ideal) || p.ideal === 0 ? "N/A" : p.ideal.toFixed(1);
          const cumplimiento = isNaN(p.cumplimiento) || p.cumplimiento === 0 ? "N/A" : p.cumplimiento.toFixed(1);

          const card = document.createElement("div");
          card.className = "bg-gray-50 rounded-lg border-t-4 shadow-md overflow-hidden transition-all duration-300";
          card.style.borderColor = p.color;

          card.innerHTML = `
            <button id="header-${projectId}" class="w-full flex justify-between items-center p-4 text-left hover:bg-gray-100 transition">
              <div>
                <h4 class="font-semibold text-herm-dark-blue">${p.nombre}</h4>
                <p class="text-xs text-gray-600"><strong>Líder:</strong> ${p.lider}</p>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-xs px-3 py-1 rounded-full text-white ${p.tailwind}">${p.estado}</span>
                <i data-lucide="chevron-down" class="w-5 h-5 text-gray-500 transition-transform"></i>
              </div>
            </button>
            ${p.vencido ? '<p class="text-xs text-red-600 font-semibold px-4 mt-1">⚠ Proyecto vencido</p>' : ''}
            <div id="body-${projectId}" class="hidden p-4 border-t bg-white">
              <p class="text-sm text-gray-700 mb-2"><strong>Comité patrocinador:</strong> ${p.comite}</p>
              <p class="text-sm text-gray-700 mb-3"><strong>Objetivo:</strong> ${p.objetivo}</p>
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                <p class="text-xs text-gray-700"><strong>Inicio:</strong> ${p.fecha_inicio || "—"}</p>
                <p class="text-xs text-gray-700"><strong>Fin:</strong> ${p.fecha_fin || "—"}</p>
                <p class="text-xs text-gray-700"><strong>Fin ME:</strong> ${p.fecha_fin_me || "—"}</p>
              </div>
              <div class="grid grid-cols-3 text-center mb-4">
                  <div>
                     <p class="text-xs text-gray-500">% Avance</p>
                     <p class="text-lg font-bold text-herm-dark-blue">${avance === "N/A" ? "N/A" : avance + "%"}</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500">% Ideal</p>
                    <p class="text-lg font-bold text-herm-dark-blue">${ideal === "N/A" ? "N/A" : ideal + "%"}</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-500">% Cumplimiento</p>
                    <p class="text-lg font-bold text-herm-dark-blue">${cumplimiento === "N/A" ? "N/A" : cumplimiento + "%"}</p>
                  </div>
              </div>
              <div class="mb-3">
                <p class="text-sm font-semibold text-herm-dark-blue">Entregables:</p>
                <p class="text-sm text-gray-600 whitespace-pre-line">${p.entregables || "—"}</p>
              </div>
              <div>
                <p class="text-sm font-semibold text-herm-dark-blue">Indicadores:</p>
                <p class="text-sm text-gray-600 whitespace-pre-line">${p.indicadores || "—"}</p>
              </div>
            </div>
          `;
          groupContainer.appendChild(card);
          const header = card.querySelector(`#header-${projectId}`);
          const body = card.querySelector(`#body-${projectId}`);
          const icon = header.querySelector("i");
          header.addEventListener("click", () => {
            const isOpen = !body.classList.contains("hidden");
            document.querySelectorAll(`#projects-${safeId} [id^="body-"]`).forEach(el => el.classList.add("hidden"));
            document.querySelectorAll(`#projects-${safeId} i[data-lucide="chevron-down"]`).forEach(el => el.style.transform = "rotate(0deg)");
            if (!isOpen) {
              body.classList.remove("hidden");
              icon.style.transform = "rotate(180deg)";
            }
          });
        });
        container.appendChild(okrCard);
      });
      lucide.createIcons();
}


function renderChart() {
  const canvas = document.getElementById("donut-chart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  const counts = { 'A Tiempo': 0, 'Con Alerta': 0, 'En Riesgo': 0, 'Sin datos': 0 };
  projectData.forEach(p => {
    if (counts.hasOwnProperty(p.estado)) counts[p.estado]++;
  });

  const orderedLabels = ['A Tiempo', 'Con Alerta', 'En Riesgo', 'Sin datos'];
  const labels = orderedLabels;
  const data = labels.map(l => counts[l]);
  const colors = labels.map(l => COLORS[l].hex);

  if (window.donutChart) window.donutChart.destroy();

  const legend = document.getElementById("chart-legend");
  legend.innerHTML = `<div id="chart-projects-list" class="mt-3 text-sm text-gray-700"></div>`;
  const projectListContainer = document.getElementById("chart-projects-list");

    window.donutChart = new Chart(ctx, {
    type: "doughnut",
    data: { labels, datasets: [{ data, backgroundColor: colors }] },
    options: {
      cutout: "70%",
      plugins: {
        legend: { display: true, labels: { color: '#005B7F', font: { size: 12, family: 'Century Gothic' } } },
        tooltip: { enabled: false },
        datalabels: {
          color: '#005B7F',
          font: { weight: 'bold', size: 30, family: 'Century Gothic' },
          formatter: (value) => value,
          anchor: 'center',
          align: 'center',
        }
      },
      onClick: (event, elements) => {
        if (elements.length > 0) {
          showProjectsByStatus(labels[elements[0].index]);
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  function showProjectsByStatus(status) {
    const projects = projectData.filter(p => p.estado === status);
    projectListContainer.innerHTML = (projects.length === 0)
    ? `<p class="text-gray-500 italic">No hay proyectos en este estado.</p>`
    : `<p class="font-semibold text-herm-dark-blue mb-1">${status}</p>
       <ul class="list-disc ml-5 space-y-1 text-gray-700">
        ${projects.map(p => `<li>${p.nombre}</li>`).join("")}
       </ul>`;
  }
}

function renderDashboard() {
  if (projectData.length === 0) return;
  document.getElementById('total-count').textContent = projectData.length;
  document.getElementById('execution-count').textContent = projectData.filter(p => p.etapa.toLowerCase().includes('ejec')).length;
  document.getElementById('structuring-count').textContent = projectData.filter(p => p.etapa.toLowerCase().includes('estruc')).length;
  document.getElementById('closure-count').textContent = projectData.filter(p => p.etapa.toLowerCase().includes('cierre')).length;

  document.getElementById('execution-count').parentElement.onclick = () => showProjectsByStage('Ejecución');
  document.getElementById('structuring-count').parentElement.onclick = () => showProjectsByStage('Estructuración');
  document.getElementById('closure-count').parentElement.onclick = () => showProjectsByStage('Cierre');

  renderProjects();
  renderChart();
}

function showProjectsByStage(stageName) {
  const filtered = projectData.filter(p => p.etapa.toLowerCase().includes(stageName.toLowerCase()));
  const list = filtered.map(p => `<li>${p.nombre}</li>`).join("");

  Swal.fire({
    title: `Proyectos en ${stageName}`,
    html: `<ul class="text-left list-disc ml-6 text-gray-700">${list || "<li>No hay proyectos en esta etapa.</li>"}</ul>`,
    icon: "info",
    confirmButtonText: "Cerrar",
    confirmButtonColor: "#005B7F"
  });
}

window.onload = () => {
  showCommitteeView();
  document.getElementById("admin-tab").addEventListener("click", showAdminView);
  document.getElementById("committee-tab").addEventListener("click", showCommitteeView);
  document.getElementById("admin-file-upload").addEventListener("change", handleFileUpload);
};

  </script>
</body>
</html>